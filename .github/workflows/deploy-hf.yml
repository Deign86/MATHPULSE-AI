# ============================================================
# Auto-deploy to Hugging Face Spaces on push to main
# - Backend (Docker): Deign86/mathpulse-api
# - Frontend (Static): Deign86/mathpulse-ai
# ============================================================
# 
# SETUP (one-time):
# 1. Go to https://huggingface.co/settings/tokens
#    Create a token with "Write" access
# 2. In your GitHub repo, go to Settings â†’ Secrets â†’ Actions
#    Add these secrets:
#      HF_TOKEN                         â€” HuggingFace write token
#      VITE_FIREBASE_API_KEY            â€” Firebase API key
#      VITE_FIREBASE_AUTH_DOMAIN        â€” Firebase auth domain
#      VITE_FIREBASE_PROJECT_ID         â€” Firebase project ID
#      VITE_FIREBASE_STORAGE_BUCKET     â€” Firebase storage bucket
#      VITE_FIREBASE_MESSAGING_SENDER_ID â€” Firebase messaging sender ID
#      VITE_FIREBASE_APP_ID             â€” Firebase app ID
#      VITE_FIREBASE_MEASUREMENT_ID     â€” Firebase measurement ID
# 3. Push to main â€” the Action will auto-deploy
# ============================================================

name: Deploy to Hugging Face Spaces

on:
  push:
    branches:
      - main
  workflow_dispatch:     # Allow manual trigger from GitHub UI

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    # Only run when backend files change (or manual trigger)
    if: >
      github.event_name == 'workflow_dispatch' ||
      contains(join(github.event.commits.*.modified, ','), 'backend/') ||
      contains(join(github.event.commits.*.added, ','), 'backend/') ||
      contains(join(github.event.commits.*.removed, ','), 'backend/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Push backend to HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Configure git for HF push
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          # Clone the HF Space repo (or create it)
          SPACE_REPO="https://Deign86:${HF_TOKEN}@huggingface.co/spaces/Deign86/mathpulse-api"
          
          git clone "${SPACE_REPO}" hf-space 2>/dev/null || {
            echo "Space repo not found â€” creating fresh push"
            mkdir hf-space && cd hf-space && git init
            git remote add origin "${SPACE_REPO}"
            cd ..
          }
          
          # Sync backend files into the Space repo
          rsync -av --delete \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            backend/ hf-space/
          
          # Commit and push
          cd hf-space
          git add -A
          git diff --staged --quiet && echo "No changes to deploy" && exit 0
          git commit -m "ðŸš€ Auto-deploy backend from GitHub (${GITHUB_SHA::7})"
          git push origin main --force
          echo "âœ… Deployed to https://huggingface.co/spaces/Deign86/mathpulse-api"

  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          VITE_API_URL: https://deign86-mathpulse-api.hf.space
        run: npm run build

      - name: Push frontend to HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          SPACE_REPO="https://Deign86:${HF_TOKEN}@huggingface.co/spaces/Deign86/mathpulse-ai"
          
          git clone "${SPACE_REPO}" hf-frontend 2>/dev/null || {
            echo "Space repo not found â€” creating fresh push"
            mkdir hf-frontend && cd hf-frontend && git init
            git remote add origin "${SPACE_REPO}"
            cd ..
          }
          
          # Sync build output into the Space repo (keep .git and README)
          rsync -av --delete \
            --exclude='.git' \
            build/ hf-frontend/

          # Ensure HF Space metadata README exists
          cat > hf-frontend/README.md << 'HFEOF'
---
title: MathPulse AI
emoji: ðŸ“
colorFrom: blue
colorTo: purple
sdk: static
pinned: false
---
HFEOF
          
          # Commit and push
          cd hf-frontend
          git add -A
          git diff --staged --quiet && echo "No changes to deploy" && exit 0
          git commit -m "ðŸš€ Auto-deploy frontend from GitHub (${GITHUB_SHA::7})"
          git push origin main --force
          echo "âœ… Deployed to https://huggingface.co/spaces/Deign86/mathpulse-ai"
